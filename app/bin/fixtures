#!/usr/bin/env php
<?php

declare(strict_types=1);

use App\Entity\User;
use App\Entity\Project;
use App\Entity\TodoList;
use App\Entity\Task;
use App\Entity\Subtask;
use App\Entity\Tag;
use App\Entity\Comment;
use App\Entity\Attachment;
use App\Entity\Reminder;
use App\Entity\Notification;
use App\Enum\TaskStatusEnum;

require dirname(__DIR__) . '/vendor/autoload.php';

$entityManager = require dirname(__DIR__) . '/doctrine.php';

echo "=== Iniciando carga de dados do sistema TODO ===" . PHP_EOL . PHP_EOL;

// ========================================
// 1. Inserir Usu√°rios
// ========================================
echo "1. Inserindo usu√°rios..." . PHP_EOL;
$usersData = include 'DataFixtures/users.php';
$users = [];

foreach ($usersData as $data) {
    $passwordHash = password_hash($data['password'], PASSWORD_BCRYPT);
    
    $user = new User(
        $data['name'],
        $data['email'],
        $passwordHash,
        $data['timezone']
    );

    $entityManager->persist($user);
    $users[] = $user;
    echo "  - Inserindo usu√°rio: {$data['name']}" . PHP_EOL;
}

$entityManager->flush();
echo "  ‚úì {count($users)} usu√°rios inseridos com sucesso!" . PHP_EOL . PHP_EOL;

// ========================================
// 2. Inserir Projetos
// ========================================
echo "2. Inserindo projetos..." . PHP_EOL;
$projectsData = include 'DataFixtures/projects.php';
$projects = [];

foreach ($projectsData as $data) {
    $randomUser = $users[array_rand($users)];
    
    $project = new Project(
        $randomUser,
        $data['name'],
        $data['color']
    );
    
    if (isset($data['description'])) {
        $project->setDescription($data['description']);
    }

    $entityManager->persist($project);
    $projects[] = $project;
    echo "  - Inserindo projeto: {$data['name']}" . PHP_EOL;
}

$entityManager->flush();
echo "  ‚úì " . count($projects) . " projetos inseridos com sucesso!" . PHP_EOL . PHP_EOL;

// ========================================
// 3. Inserir Listas
// ========================================
echo "3. Inserindo listas..." . PHP_EOL;
$listsData = include 'DataFixtures/lists.php';
$lists = [];

foreach ($listsData as $data) {
    $randomUser = $users[array_rand($users)];
    $randomProject = rand(0, 1) ? $projects[array_rand($projects)] : null;
    
    $list = new TodoList(
        $randomUser,
        $data['name'],
        $data['order']
    );
    
    if ($randomProject) {
        $list->setProject($randomProject);
    }

    $entityManager->persist($list);
    $lists[] = $list;
    echo "  - Inserindo lista: {$data['name']}" . PHP_EOL;
}

$entityManager->flush();
echo "  ‚úì " . count($lists) . " listas inseridas com sucesso!" . PHP_EOL . PHP_EOL;

// ========================================
// 4. Inserir Tags
// ========================================
echo "4. Inserindo tags..." . PHP_EOL;
$tagsData = include 'DataFixtures/tags.php';
$tags = [];

foreach ($tagsData as $data) {
    $randomUser = $users[array_rand($users)];
    
    $tag = new Tag(
        $randomUser,
        $data['name'],
        $data['color']
    );

    $entityManager->persist($tag);
    $tags[] = $tag;
    echo "  - Inserindo tag: {$data['name']}" . PHP_EOL;
}

$entityManager->flush();
echo "  ‚úì " . count($tags) . " tags inseridas com sucesso!" . PHP_EOL . PHP_EOL;

// ========================================
// 5. Inserir Tarefas
// ========================================
echo "5. Inserindo tarefas..." . PHP_EOL;
$tasksData = include 'DataFixtures/tasks.php';
$tasks = [];

foreach ($tasksData as $data) {
    $randomList = $lists[array_rand($lists)];
    
    $task = new Task(
        $randomList,
        $data['title'],
        $data['priority'],
        $data['order']
    );
    
    if (isset($data['description'])) {
        $task->setDescription($data['description']);
    }
    
    if (isset($data['startDate'])) {
        $task->setStartDate($data['startDate']);
    }
    
    if (isset($data['dueDate'])) {
        $task->setDueDate($data['dueDate']);
    }
    
    // Adicionar tags aleat√≥rias (1-3 tags por tarefa)
    $numTags = rand(1, 3);
    $randomTags = array_rand($tags, min($numTags, count($tags)));
    if (!is_array($randomTags)) {
        $randomTags = [$randomTags];
    }
    
    foreach ($randomTags as $tagIndex) {
        $task->addTag($tags[$tagIndex]);
    }

    $entityManager->persist($task);
    $tasks[] = $task;
    echo "  - Inserindo tarefa: {$data['title']}" . PHP_EOL;
}

$entityManager->flush();
echo "  ‚úì " . count($tasks) . " tarefas inseridas com sucesso!" . PHP_EOL . PHP_EOL;

// ========================================
// 6. Inserir Subtarefas
// ========================================
echo "6. Inserindo subtarefas..." . PHP_EOL;
$subtasksData = include 'DataFixtures/subtasks.php';
$subtasks = [];

foreach ($subtasksData as $data) {
    $randomTask = $tasks[array_rand($tasks)];
    
    $subtask = new Subtask(
        $randomTask,
        $data['title'],
        $data['order']
    );
    
    $subtask->setCompleted($data['completed']);

    $entityManager->persist($subtask);
    $subtasks[] = $subtask;
    echo "  - Inserindo subtarefa: {$data['title']}" . PHP_EOL;
}

$entityManager->flush();
echo "  ‚úì " . count($subtasks) . " subtarefas inseridas com sucesso!" . PHP_EOL . PHP_EOL;

// ========================================
// 7. Inserir Coment√°rios
// ========================================
echo "7. Inserindo coment√°rios..." . PHP_EOL;
$commentsData = include 'DataFixtures/comments.php';
$comments = [];

foreach ($commentsData as $data) {
    $randomTask = $tasks[array_rand($tasks)];
    $randomUser = $users[array_rand($users)];
    
    $comment = new Comment(
        $randomTask,
        $randomUser,
        $data['content']
    );

    $entityManager->persist($comment);
    $comments[] = $comment;
    echo "  - Inserindo coment√°rio" . PHP_EOL;
}

$entityManager->flush();
echo "  ‚úì " . count($comments) . " coment√°rios inseridos com sucesso!" . PHP_EOL . PHP_EOL;

// ========================================
// 8. Inserir Anexos
// ========================================
echo "8. Inserindo anexos..." . PHP_EOL;
$attachmentsData = include 'DataFixtures/attachments.php';
$attachments = [];

foreach ($attachmentsData as $data) {
    $randomTask = $tasks[array_rand($tasks)];
    $randomUser = $users[array_rand($users)];
    
    $attachment = new Attachment(
        $randomTask,
        $randomUser,
        $data['fileName'],
        $data['mimeType'],
        $data['sizeBytes'],
        $data['storageUrl']
    );

    $entityManager->persist($attachment);
    $attachments[] = $attachment;
    echo "  - Inserindo anexo: {$data['fileName']}" . PHP_EOL;
}

$entityManager->flush();
echo "  ‚úì " . count($attachments) . " anexos inseridos com sucesso!" . PHP_EOL . PHP_EOL;

// ========================================
// 9. Inserir Lembretes
// ========================================
echo "9. Inserindo lembretes..." . PHP_EOL;
$remindersData = include 'DataFixtures/reminders.php';
$reminders = [];

foreach ($remindersData as $data) {
    $randomTask = $tasks[array_rand($tasks)];
    
    $reminder = new Reminder(
        $randomTask,
        $data['reminderDateTime'],
        $data['channel']
    );

    $entityManager->persist($reminder);
    $reminders[] = $reminder;
    echo "  - Inserindo lembrete: {$data['reminderDateTime']->format('Y-m-d H:i:s')}" . PHP_EOL;
}

$entityManager->flush();
echo "  ‚úì " . count($reminders) . " lembretes inseridos com sucesso!" . PHP_EOL . PHP_EOL;

// ========================================
// 10. Inserir Notifica√ß√µes
// ========================================
echo "10. Inserindo notifica√ß√µes..." . PHP_EOL;
$notificationsData = include 'DataFixtures/notifications.php';
$notifications = [];

foreach ($notificationsData as $data) {
    $randomUser = $users[array_rand($users)];
    
    $notification = new Notification(
        $randomUser,
        $data['type'],
        $data['title'],
        $data['message']
    );

    $entityManager->persist($notification);
    $notifications[] = $notification;
    echo "  - Inserindo notifica√ß√£o: {$data['title']}" . PHP_EOL;
}

$entityManager->flush();
echo "  ‚úì " . count($notifications) . " notifica√ß√µes inseridas com sucesso!" . PHP_EOL . PHP_EOL;

// ========================================
// Resumo Final
// ========================================
echo "======================================" . PHP_EOL;
echo "üéâ CARGA DE DADOS CONCLU√çDA COM SUCESSO!" . PHP_EOL;
echo "======================================" . PHP_EOL;
echo "Total de registros inseridos:" . PHP_EOL;
echo "  ‚Ä¢ Usu√°rios: " . count($users) . PHP_EOL;
echo "  ‚Ä¢ Projetos: " . count($projects) . PHP_EOL;
echo "  ‚Ä¢ Listas: " . count($lists) . PHP_EOL;
echo "  ‚Ä¢ Tags: " . count($tags) . PHP_EOL;
echo "  ‚Ä¢ Tarefas: " . count($tasks) . PHP_EOL;
echo "  ‚Ä¢ Subtarefas: " . count($subtasks) . PHP_EOL;
echo "  ‚Ä¢ Coment√°rios: " . count($comments) . PHP_EOL;
echo "  ‚Ä¢ Anexos: " . count($attachments) . PHP_EOL;
echo "  ‚Ä¢ Lembretes: " . count($reminders) . PHP_EOL;
echo "  ‚Ä¢ Notifica√ß√µes: " . count($notifications) . PHP_EOL;
echo "======================================" . PHP_EOL;
